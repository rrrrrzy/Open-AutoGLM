# 定时器功能增强说明

## 新增功能

Phone Agent UI 的定时执行功能已增强，现在支持两种定时模式：

### 1. 间隔执行模式 (Interval Mode)

按固定时间间隔重复执行任务。

**特点：**
- 从启动开始，每隔指定时间执行一次
- 可设置 1-1440 分钟（1天）的间隔
- 适合需要持续监控的场景

**示例：**
- 每 30 分钟检查一次邮件
- 每 2 小时刷新一次数据
- 每 60 分钟执行一次备份

### 2. 定时执行模式 (Specific Time Mode) ⭐ 新增

每天在固定时间点执行任务。

**特点：**
- 每天在指定时间自动执行
- 支持任意时间设置（00:00-23:59）
- 错过时间会自动安排到第二天
- 适合需要在特定时间执行的场景

**示例：**
- 每天早上 8:00 发送日报
- 每天晚上 22:00 进行数据备份
- 每天中午 12:00 检查更新

## 使用方法

### 设置间隔执行

1. 在"定时执行"区域，选择模式为"间隔执行 (Interval)"
2. 设置间隔时间（分钟）
3. 勾选"启用定时执行 (Enable)"
4. 系统会按照设定的间隔重复执行任务

### 设置定时执行

1. 在"定时执行"区域，选择模式为"定时执行 (Specific Time)"
2. 设置每天执行的具体时间（例如：08:00）
3. 勾选"启用定时执行 (Enable)"
4. 系统会在每天的指定时间自动执行任务

### 查看下次执行时间

界面底部会实时显示下次执行的时间和倒计时：
```
下次执行 (Next): 2025-12-27 08:00:00 (7小时30分钟后)
```

## 配置保存

所有设置会自动保存，包括：
- 定时模式（间隔/定时）
- 间隔时间
- 具体执行时间
- 启用状态

重启程序后会自动恢复之前的设置。

## 技术实现

### 调度器增强

`ui/scheduler.py` 新增功能：
- `set_specific_time(hour, minute)` - 设置具体执行时间
- `get_next_execution_time()` - 获取下次执行时间
- `get_mode()` - 获取当前模式
- 自动计算到下次执行的延迟时间
- 执行后自动安排下一次执行

### 设置管理

`ui/settings.py` 新增设置项：
- `schedule_mode` - 定时模式（interval/specific_time）
- `schedule_time_hour` - 执行小时
- `schedule_time_minute` - 执行分钟

### UI 组件

`ui/main_window.py` 新增控件：
- 模式选择下拉框
- 时间选择器（QTimeEdit）
- 实时倒计时显示
- 自动切换显示对应模式的设置

## 使用场景示例

### 场景 1：每天早上定时发送报告

```
模式：定时执行 (Specific Time)
时间：08:00
任务：打开企业微信，发送日报给领导
```

### 场景 2：工作时间定期检查消息

```
模式：间隔执行 (Interval)
间隔：30 分钟
任务：打开微信，检查是否有新消息
```

### 场景 3：夜间备份数据

```
模式：定时执行 (Specific Time)
时间：22:00
任务：打开云盘应用，执行备份操作
```

## 注意事项

1. **电脑需要保持运行**
   - 程序需要在后台运行才能执行定时任务
   - 可以最小化到系统托盘

2. **时间错过处理**
   - 如果在设定时间程序未运行，任务会在第二天执行
   - 不会补执行错过的任务

3. **任务执行时长**
   - 如果任务执行时间超过间隔时间，下次执行会等当前任务完成
   - 定时模式下，如果任务跨天执行，下次还是在设定时间

4. **资源占用**
   - 定时器使用系统定时器，资源占用极小
   - 倒计时显示每秒更新一次

## 测试

运行测试脚本验证功能：

```bash
python test_scheduler.py
```

预期输出：
```
🧪 测试调度器增强功能

1️⃣ 测试间隔模式...
   ✅ 间隔模式测试通过

2️⃣ 测试定时模式...
   ✅ 定时模式测试通过

3️⃣ 测试下次执行时间计算...
   下次执行: 2025-12-27 08:30:00
   ✅ 时间计算测试通过

🎉 所有测试通过！
```

## 未来扩展

可考虑添加的功能：
- [ ] 支持每周特定日期执行
- [ ] 支持多个定时任务
- [ ] 任务执行历史记录
- [ ] 跳过节假日选项
- [ ] 执行失败重试机制
