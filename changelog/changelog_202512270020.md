# 打包说明文档

## 概述

Phone Agent 支持打包为独立的可执行程序，无需 Python 环境即可运行。

## 打包步骤

### 1. 安装依赖

首先确保已安装所有依赖（包括 PyInstaller）：

```bash
pip install -r requirements.txt
```

或单独安装 PyInstaller：

```bash
pip install pyinstaller
```

### 2. 执行打包

#### Windows

```powershell
.\build.ps1
```

或手动执行：

```powershell
pyinstaller phone_agent.spec
```

#### Linux/macOS

```bash
chmod +x build.sh
./build.sh
```

或手动执行：

```bash
pyinstaller phone_agent.spec
```

### 3. 获取可执行文件

打包完成后，可执行文件位于：

- **Windows**: `dist\PhoneAgent.exe`
- **Linux**: `dist/PhoneAgent`
- **macOS**: `dist/PhoneAgent.app`

## 运行可执行程序

### Windows

双击 `PhoneAgent.exe` 或在命令行运行：

```powershell
.\dist\PhoneAgent.exe
```

### Linux

```bash
./dist/PhoneAgent
```

### macOS

```bash
open dist/PhoneAgent.app
```

或双击 `PhoneAgent.app`

## 程序特性

### 默认行为

- **打包版本**：双击运行时自动启动 GUI 界面，无需 `--ui` 参数
- **开发版本**：需要使用 `python main.py --ui` 启动 GUI

### GUI 模式特性

1. **系统托盘图标**
   - 最小化时隐藏到系统托盘
   - 双击托盘图标恢复窗口
   - 右键菜单：显示/隐藏/退出

2. **无控制台窗口**
   - 打包版本不显示黑色控制台窗口
   - 所有输出在 GUI 中显示

3. **独立运行**
   - 不依赖 Python 环境
   - 不依赖终端
   - 完全独立的桌面应用

## 自定义图标

### 替换托盘图标

1. 准备图标文件（PNG 格式推荐）
2. 替换项目根目录的 `image.png`
3. 重新打包即可

### 替换程序图标

编辑 `phone_agent.spec` 文件：

```python
exe = EXE(
    # ...
    icon='your_icon.ico',  # Windows 使用 .ico 格式
    # 或
    icon='your_icon.icns',  # macOS 使用 .icns 格式
)
```

## 打包配置说明

所有打包配置在 `phone_agent.spec` 文件中：

### 关键配置项

1. **资源文件** (`datas`)
   - `image.png`: 系统托盘图标
   - `resources/`: 隐私政策等资源

2. **隐藏导入** (`hiddenimports`)
   - PyQt6 模块
   - phone_agent 所有子模块
   - 其他动态导入的模块

3. **排除模块** (`excludes`)
   - matplotlib, scipy, pandas 等不需要的大型库
   - 减小打包体积

4. **控制台窗口** (`console=False`)
   - GUI 模式不显示控制台

5. **UPX 压缩** (`upx=True`)
   - 压缩可执行文件大小

## 常见问题

### Q: 打包后文件很大？

A: 这是正常的，因为包含了完整的 Python 运行时和所有依赖。可以：
- 启用 UPX 压缩（已默认启用）
- 排除不需要的模块（在 `excludes` 中添加）
- 使用虚拟环境打包，只安装必需的包

### Q: 打包后运行报错找不到模块？

A: 检查 `phone_agent.spec` 中的 `hiddenimports` 是否包含该模块。

### Q: 如何更新打包后的程序？

A: 修改代码后重新执行打包步骤即可。

### Q: 能否跨平台使用打包文件？

A: 不能。需要在各平台分别打包：
- Windows 打包生成 `.exe`（仅在 Windows 运行）
- Linux 打包生成可执行文件（仅在 Linux 运行）
- macOS 打包生成 `.app`（仅在 macOS 运行）

## CLI 模式

如需在打包版本中使用 CLI 模式，可以：

```bash
# Windows
.\dist\PhoneAgent.exe --help
.\dist\PhoneAgent.exe --task "打开微信"

# Linux/macOS
./dist/PhoneAgent --help
./dist/PhoneAgent --task "打开微信"
```

注意：使用 CLI 模式时，需要修改 `phone_agent.spec` 中的 `console=True` 以显示控制台输出。

## 技术细节

### 资源路径处理

打包后，资源文件位置发生变化。使用 `ui.resource_path.get_resource_path()` 函数自动处理：

```python
from ui.resource_path import get_resource_path

# 自动适配开发/打包环境
icon_path = get_resource_path("image.png")
config_path = get_resource_path("resources/privacy_policy.txt")
```

### 运行环境检测

```python
import sys

# 检测是否为打包版本
is_packaged = getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS')

if is_packaged:
    # 打包版本逻辑
    print("Running as packaged executable")
else:
    # 开发版本逻辑
    print("Running in development mode")
```

## 分发建议

1. **Windows**
   - 使用 Inno Setup 或 NSIS 创建安装程序
   - 添加桌面快捷方式
   - 添加到开始菜单

2. **macOS**
   - 创建 DMG 镜像
   - 代码签名（需要开发者证书）

3. **Linux**
   - 创建 AppImage
   - 或打包为 DEB/RPM 包

## 维护建议

- 每次发布新版本前重新打包
- 在目标平台上测试打包后的程序
- 保持 `phone_agent.spec` 配置文件的版本控制
- 记录每次打包的版本号和变更
